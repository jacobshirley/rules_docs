# This workflow creates additional tags for a release
name: Release Tags
on:
  push:
    tags:
        - 'v*.*.*' # Trigger on version tags like v1.0.0, v2.1.3, etc.
jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v2
        id: generate-token
        with:
            app-id: 2384674
            private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
        with:
            token: ${{ steps.generate-token.outputs.token }}
            persist-credentials: true
      - name: Git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Create major version tag
        run: |
          # Check if this was triggered by a tag
          if [[ ! "$GITHUB_REF" =~ ^refs/tags/ ]]; then
            echo "Error: This workflow should only run on tag pushes"
            echo "Current ref: $GITHUB_REF"
            exit 1
          fi
          
          # Get the tag that triggered this workflow
          current_tag=${GITHUB_REF#refs/tags/}
          echo "Current tag: $current_tag"
          
          # Validate tag format (must be vX.Y.Z)
          if [[ ! "$current_tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Tag '$current_tag' does not match expected format (vX.Y.Z)"
            exit 1
          fi
          
          # Extract major version (e.g., v1.0.1 -> v1)
          major_version=$(echo "$current_tag" | sed -E 's/^v?([0-9]+)\..*/v\1/')
          echo "Major version: $major_version"
          
          # Create and push the major version tag
          git tag "$major_version" --force
          git push origin "$major_version" --force
      - name: Create latest tag
        run: |
          git tag latest --force
          git push origin latest --force
    permissions:
      contents: write